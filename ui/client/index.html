<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Citigold Wealth Advisor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #000;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .mobile-app {
            width: 375px;
            height: 812px;
            background-color: #000;
            border-radius: 40px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chatbox {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            color: white;
            overflow: hidden;
        }

        .chatbox-header {
            background-color: #002d5b; /* Citi Blue */
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #cda434; /* Citi Gold */
        }

        .chatbox-header-title {
            display: flex;
            align-items: center;
            font-weight: 500;
        }

        .chatbox-body {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 1rem;
            overflow-y: auto;
        }

        .mic-button-bg {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            margin: auto;
        }

        .mic-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .mic-active {
            background-color: rgba(255, 51, 51, 0.4);
        }

        .chatbox-footer {
            padding: 1rem;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid #cda434; /* Citi Gold */
        }

        .chat-control-btn {
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

        .chat-control-btn:hover {
            background-color: rgba(255, 255, 255, 0.25);
        }

        .chat-control-btn.end-call {
            background-color: #DC2626;
        }

        .chat-control-btn.end-call:hover {
            background-color: #EF4444;
        }

        .chat-message {
            max-width: 80%;
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .user-message {
            align-self: flex-end;
            background-color: #002d5b; /* Citi Blue */
            margin-left: auto;
        }

        .assistant-message {
            align-self: flex-start;
            background-color: rgba(255, 255, 255, 0.1);
            margin-right: auto;
        }

        .audio-wave {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 20px;
            margin: 10px 0;
        }

        .audio-wave span {
            display: inline-block;
            width: 3px;
            height: 100%;
            margin: 0 2px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 3px;
            animation: wave 1.2s infinite ease-in-out;
        }

        .audio-wave span:nth-child(2) { animation-delay: 0.1s; }
        .audio-wave span:nth-child(3) { animation-delay: 0.2s; }
        .audio-wave span:nth-child(4) { animation-delay: 0.3s; }
        .audio-wave span:nth-child(5) { animation-delay: 0.4s; }

        @keyframes wave {
            0%, 40%, 100% { transform: scaleY(0.4); }
            20% { transform: scaleY(1); }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #002d5b; /* Citi Blue */
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #004284;
        }
    </style>
</head>
<body>

    <div class="mobile-app">
        <div id="chatbox" class="chatbox">
            <div class="chatbox-header">
                <div class="chatbox-header-title">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 p-1 bg-cda434 text-002d5b rounded-full" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" />
                    </svg>
                    <span>Citigold Wealth Advisor</span>
                </div>
                <div id="connection-status" class="text-xs text-right">Connecting...</div>
            </div>

            <div id="session-id-display" class="text-xs text-center bg-opacity-80 bg-black p-2 text-gray-400 border-t border-b border-gray-700">
                <span id="session-id-text" class="font-mono font-bold">Waiting for session...</span>
            </div>

            <div class="chatbox-body" id="chat-messages">
                <!-- Chat messages will be added here -->
                <div class="chat-message assistant-message">
                    Welcome to Citigold Financial Services. My name is Alex. How may I assist you with your investment needs today?
                </div>
            </div>

            <div id="audio-indicator" class="px-4 pb-2 flex justify-center items-center h-10 hidden">
                <div class="audio-wave">
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>

            <div class="chatbox-footer">
                <button id="cameraButton" class="chat-control-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                </button>
                <div id="mic-button-container" class="mic-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                    </svg>
                </div>
                <button id="endCallButton" class="chat-control-btn end-call">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16 8l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M3 12l6.414 6.414a2 2 0 002.828 0L19 12M3 12l6.414-6.414a2 2 0 012.828 0L19 12" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script src="audio-client.js"></script>

    <script>
        const micButton = document.getElementById('mic-button-container');
        const endCallButton = document.getElementById('endCallButton');
        const chatMessages = document.getElementById('chat-messages');
        const audioIndicator = document.getElementById('audio-indicator');
        let audioClient;
        let isRecording = false;

        micButton.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });

        endCallButton.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            }
            addMessage("Call ended. How else can I help you?", "assistant");
            if (audioClient) {
                audioClient.close();
            }
            initializeAudioClient();
        });

        async function initializeAudioClient() {
            // Create a new instance for a clean start
            audioClient = new AudioClient('ws://localhost:8080');

            let currentResponseText = '';
            let currentResponseElement = null;

            // Add event listeners instead of assigning callbacks
            audioClient.addEventListener('ready', () => {
                console.log('Audio client ready');
                updateConnectionStatus('Connected');
            });

            audioClient.addEventListener('connecting', () => {
                updateConnectionStatus('Connecting...');
            });

            audioClient.addEventListener('reconnecting', (event) => {
                updateConnectionStatus(`Reconnecting (Attempt ${event.detail})...`);
            });

            audioClient.addEventListener('disconnected', () => {
                updateConnectionStatus('Disconnected');
            });

            audioClient.addEventListener('reconnect_failed', () => {
                updateConnectionStatus('Reconnection Failed. Please refresh.');
                addMessage("I'm sorry, I was unable to reconnect. Please check your internet connection and refresh the page.", "assistant");
            });

            audioClient.addEventListener('session_id', (event) => {
                const sessionId = event.detail;
                const sessionIdText = document.getElementById('session-id-text');
                const sessionIdDisplay = document.getElementById('session-id-display');

                if (sessionIdText && sessionIdDisplay) {
                    sessionIdText.textContent = `Session ID: ${sessionId}`;
                    sessionIdDisplay.classList.remove('text-gray-400');
                    sessionIdDisplay.classList.add('text-yellow-300');
                }
            });

            audioClient.addEventListener('audio', (event) => {
                audioIndicator.classList.remove('hidden');
            });

            audioClient.addEventListener('text', (event) => {
                const text = event.detail;
                if (text && text.trim()) {
                    if (!currentResponseElement || !document.body.contains(currentResponseElement)) {
                        currentResponseText = text;
                        currentResponseElement = document.createElement('div');
                        currentResponseElement.className = 'chat-message assistant-message';
                        currentResponseElement.textContent = text;
                        chatMessages.appendChild(currentResponseElement);
                    } else {
                        currentResponseText += ' ' + text.trim();
                        currentResponseElement.textContent = currentResponseText;
                    }
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            });

            audioClient.addEventListener('turn_complete', () => {
                audioIndicator.classList.add('hidden');
                currentResponseText = '';
                currentResponseElement = null;
            });

            audioClient.addEventListener('error', (event) => {
                console.error('Audio client error:', event.detail);
                addMessage("Sorry, I encountered an error. Please try again.", "assistant");
                currentResponseText = '';
                currentResponseElement = null;
                updateConnectionStatus('Error');
            });

            audioClient.addEventListener('interrupted', () => {
                console.log('Interruption detected, stopping audio playback');
                audioIndicator.classList.add('hidden');
                audioClient.interrupt();
                currentResponseText = '';
                currentResponseElement = null;
            });

            // New event listener for user transcript
            audioClient.addEventListener('user_transcript', (event) => {
                const transcript = event.detail;
                const tempMessages = document.querySelectorAll('.user-message');
                if (tempMessages.length > 0) {
                    const lastMessage = tempMessages[tempMessages.length - 1];
                    lastMessage.textContent = transcript;
                }
            });

            try {
                await audioClient.connect();
            } catch (error) {
                console.error('Failed to initialize audio client:', error);
                updateConnectionStatus('Connection Failed');
                addMessage("Sorry, I'm having trouble connecting. Please try again later.", "assistant");
            }
        }

        function updateConnectionStatus(status) {
            const statusDisplay = document.getElementById('connection-status');
            if (statusDisplay) {
                statusDisplay.textContent = status;
                statusDisplay.classList.remove('text-green-400', 'text-yellow-400', 'text-red-400');
                if (status === 'Connected') {
                    statusDisplay.classList.add('text-green-400');
                } else if (status.startsWith('Reconnecting') || status === 'Connecting...') {
                    statusDisplay.classList.add('text-yellow-400');
                } else {
                    statusDisplay.classList.add('text-red-400');
                }
            }
        }

        async function startRecording() {
            try {
                const success = await audioClient.startRecording();
                if (success) {
                    isRecording = true;
                    micButton.classList.add('mic-active');
                    addMessage("...", "user");
                }
            } catch (error) {
                console.error('Error starting recording:', error);
            }
        }

        function stopRecording() {
            if (!isRecording) return;
            audioClient.stopRecording();
            isRecording = false;
            micButton.classList.remove('mic-active');
            const tempMessages = document.querySelectorAll('.user-message');
            if (tempMessages.length > 0) {
                const lastMessage = tempMessages[tempMessages.length - 1];
                if (lastMessage.textContent === '...') {
                    // The "..." will be replaced by the transcript from the server.
                    // If no transcript is received, the "..." will remain.
                }
            }
        }

        function addMessage(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.className = `chat-message ${sender}-message`;
            messageElement.textContent = text;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        window.addEventListener('load', initializeAudioClient);
    </script>
</body>
</html>
